# Local Action Queue æ¸¬è©¦æŒ‡å—

## ğŸ¯ ç›®çš„
é©—è­‰ `ProgressService` çš„ local action queue åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

---

## ğŸ“‹ æ¸¬è©¦æ¸…å–®

### âœ… æ¸¬è©¦ 1ï¼šåŸºæœ¬æ“ä½œï¼ˆç«‹å³éŸ¿æ‡‰ï¼‰

**æ­¥é©Ÿï¼š**
1. æ‰“é–‹æ‡‰ç”¨
2. æ‰¾åˆ°ä¸€å€‹å­¸ç¿’å…§å®¹
3. é»æ“Šã€Œæˆ‘å­¸æœƒäº†ã€æŒ‰éˆ•
4. è§€å¯Ÿ UI æ˜¯å¦ç«‹å³æ›´æ–°

**é æœŸçµæœï¼š**
- âœ… UI ç«‹å³é¡¯ç¤ºã€Œå·²å­¸æœƒã€ï¼ˆä¸ç­‰å¾…ç¶²çµ¡ï¼‰
- âœ… Debug Console é¡¯ç¤ºï¼š
  ```
  flutter: ğŸ“‹ å·²åŠ å…¥æœ¬åœ°ä½‡åˆ—ï¼šaction=learned, contentId=xxx
  flutter: âœ… å·²åŒæ­¥ï¼šaction=learned, contentId=xxx
  ```

**é©—è­‰æ–¹å¼ï¼š**
- è§€å¯ŸæŒ‰éˆ•éŸ¿æ‡‰æ™‚é–“ï¼ˆæ‡‰è©² < 100msï¼‰
- æª¢æŸ¥ Firestore Consoleï¼Œç¢ºèªæ•¸æ“šå·²å¯«å…¥

---

### âœ… æ¸¬è©¦ 2ï¼šé›¢ç·šæ¨¡å¼ï¼ˆqueue ä¿å­˜ï¼‰

**æ­¥é©Ÿï¼š**
1. **é—œé–‰ç¶²çµ¡**ï¼ˆé£›èˆªæ¨¡å¼æˆ–é—œé–‰ WiFiï¼‰
2. é»æ“Šã€Œæˆ‘å­¸æœƒäº†ã€æŒ‰éˆ•
3. è§€å¯Ÿ UI æ˜¯å¦æ›´æ–°
4. **é–‹å•Ÿç¶²çµ¡**
5. ç­‰å¾… 5-10 ç§’

**é æœŸçµæœï¼š**
- âœ… é›¢ç·šæ™‚ UI ç«‹å³æ›´æ–°
- âœ… Debug Console é¡¯ç¤ºï¼š
  ```
  flutter: ğŸ“‹ å·²åŠ å…¥æœ¬åœ°ä½‡åˆ—ï¼šaction=learned, contentId=xxx
  flutter: âŒ åŒæ­¥å¤±æ•—ï¼Œä¿ç•™åœ¨ä½‡åˆ—ï¼šaction=learned, contentId=xxx
  ```
- âœ… ç¶²çµ¡æ¢å¾©å¾Œè‡ªå‹•åŒæ­¥ï¼š
  ```
  flutter: ğŸ”„ é–‹å§‹åŒæ­¥ 1 å€‹æœ¬åœ°è¡Œå‹•åˆ° Firestore...
  flutter: âœ… å·²åŒæ­¥ï¼šaction=learned, contentId=xxx
  ```

**é©—è­‰æ–¹å¼ï¼š**
- æª¢æŸ¥ Firestore Consoleï¼Œç¢ºèªæ•¸æ“šåœ¨ç¶²çµ¡æ¢å¾©å¾Œå‡ºç¾

---

### âœ… æ¸¬è©¦ 3ï¼šå¿«é€Ÿé€£çºŒæ“ä½œï¼ˆé˜²æŠ–ï¼‰

**æ­¥é©Ÿï¼š**
1. å¿«é€Ÿé€£çºŒé»æ“Š 3 æ¬¡ã€Œæˆ‘å­¸æœƒäº†ã€æŒ‰éˆ•
2. è§€å¯Ÿ UI éŸ¿æ‡‰

**é æœŸçµæœï¼š**
- âœ… UI æ¯æ¬¡é»æ“Šéƒ½ç«‹å³éŸ¿æ‡‰
- âœ… ä¸æœƒå‡ºç¾å¡é “æˆ–å»¶é²
- âœ… Debug Console é¡¯ç¤ºæ‰€æœ‰æ“ä½œéƒ½è¢«è¨˜éŒ„

**é©—è­‰æ–¹å¼ï¼š**
- è§€å¯Ÿæ˜¯å¦æœ‰ä»»ä½•å¡é “
- æª¢æŸ¥ Debug Console æ—¥èªŒæ•¸é‡

---

### âœ… æ¸¬è©¦ 4ï¼šç¶²çµ¡å»¶é²ï¼ˆæ…¢é€Ÿç¶²çµ¡ï¼‰

**æ­¥é©Ÿï¼š**
1. ä½¿ç”¨ iOS Simulator æˆ– Android Emulator çš„ç¶²çµ¡é™é€ŸåŠŸèƒ½
2. è¨­ç½®ç‚ºã€Œ3Gã€æˆ–ã€ŒEdgeã€æ¨¡å¼
3. é»æ“Šã€Œæˆ‘å­¸æœƒäº†ã€æŒ‰éˆ•
4. è§€å¯Ÿ UI éŸ¿æ‡‰

**é æœŸçµæœï¼š**
- âœ… UI ç«‹å³æ›´æ–°ï¼ˆä¸ç­‰å¾…æ…¢é€Ÿç¶²çµ¡ï¼‰
- âœ… èƒŒæ™¯æ…¢æ…¢åŒæ­¥åˆ° Firestore
- âœ… ç”¨æˆ¶æ„Ÿè¦ºä¸åˆ°ç¶²çµ¡å»¶é²

**é©—è­‰æ–¹å¼ï¼š**
- è§€å¯ŸæŒ‰éˆ•éŸ¿æ‡‰æ™‚é–“ï¼ˆæ‡‰è©²ä»ç„¶ < 100msï¼‰

---

### âœ… æ¸¬è©¦ 5ï¼šæ‡‰ç”¨é‡å•Ÿï¼ˆqueue æŒä¹…åŒ–ï¼‰

**æ­¥é©Ÿï¼š**
1. é—œé–‰ç¶²çµ¡
2. é»æ“Šã€Œæˆ‘å­¸æœƒäº†ã€æŒ‰éˆ• 2-3 æ¬¡
3. **å®Œå…¨é—œé–‰æ‡‰ç”¨**ï¼ˆä¸æ˜¯æœ€å°åŒ–ï¼‰
4. **é‡æ–°å•Ÿå‹•æ‡‰ç”¨**
5. é–‹å•Ÿç¶²çµ¡
6. ç­‰å¾… 10 ç§’

**é æœŸçµæœï¼š**
- âœ… æ‡‰ç”¨é‡å•Ÿå¾Œï¼Œqueue ä¸­çš„æ“ä½œä»ç„¶å­˜åœ¨
- âœ… ç¶²çµ¡æ¢å¾©å¾Œè‡ªå‹•åŒæ­¥æ‰€æœ‰æ“ä½œ
- âœ… Firestore ä¸­å‡ºç¾æ‰€æœ‰æ“ä½œçš„è¨˜éŒ„

**é©—è­‰æ–¹å¼ï¼š**
- æª¢æŸ¥ SharedPreferences ä¸­çš„ `local_action_queue_v1`
- æª¢æŸ¥ Firestore Console ç¢ºèªæ‰€æœ‰æ•¸æ“šéƒ½å·²åŒæ­¥

---

### âœ… æ¸¬è©¦ 6ï¼šå¤šç¨®æ“ä½œï¼ˆlearned, snoozed, etc.ï¼‰

**æ­¥é©Ÿï¼š**
1. é—œé–‰ç¶²çµ¡
2. åŸ·è¡Œä»¥ä¸‹æ“ä½œï¼š
   - æ¨™è¨˜ 1 å€‹å…§å®¹ç‚ºã€Œå·²å­¸æœƒã€
   - æ¨™è¨˜ 1 å€‹å…§å®¹ç‚ºã€Œç¨å¾Œå†å­¸ã€
   - é–‹å•Ÿ 1 å€‹å…§å®¹
3. é–‹å•Ÿç¶²çµ¡
4. ç­‰å¾…åŒæ­¥

**é æœŸçµæœï¼š**
- âœ… æ‰€æœ‰æ“ä½œéƒ½ç«‹å³åœ¨ UI é¡¯ç¤º
- âœ… ç¶²çµ¡æ¢å¾©å¾Œæ‰€æœ‰æ“ä½œéƒ½åŒæ­¥åˆ° Firestore
- âœ… Queue ä¸­çš„é …ç›®è¢«æ­£ç¢ºæ¸…ç†

**é©—è­‰æ–¹å¼ï¼š**
- æª¢æŸ¥ Firestore Console ä¸­çš„å¤šå€‹ progress æ–‡æª”

---

## ğŸ” Debug å·¥å…·

### 1. æŸ¥çœ‹ Queue å…§å®¹ï¼ˆé–‹ç™¼ç‰ˆï¼‰

åœ¨æ¸¬è©¦æ™‚ï¼Œå¯ä»¥æ·»åŠ è‡¨æ™‚ä»£ç¢¼æŸ¥çœ‹ queueï¼š

```dart
// è‡¨æ™‚æ¸¬è©¦ä»£ç¢¼ï¼ˆä¸è¦æäº¤åˆ°ç”Ÿç”¢ç’°å¢ƒï¼‰
void _debugPrintQueue() async {
  final sp = await SharedPreferences.getInstance();
  final raw = sp.getString('local_action_queue_v1');
  
  if (raw == null || raw.isEmpty) {
    print('ğŸ“‹ Queue æ˜¯ç©ºçš„');
    return;
  }
  
  final list = jsonDecode(raw) as List<dynamic>;
  print('ğŸ“‹ Queue ä¸­æœ‰ ${list.length} å€‹é …ç›®ï¼š');
  
  for (var item in list) {
    print('  - ${item['action']}: ${item['contentId']} (synced: ${item['synced']})');
  }
}
```

### 2. å¼·åˆ¶åŒæ­¥

æ·»åŠ ä¸€å€‹æ¸¬è©¦æŒ‰éˆ•è§¸ç™¼å¼·åˆ¶åŒæ­¥ï¼š

```dart
ElevatedButton(
  onPressed: () async {
    final progress = ref.read(progressServiceProvider);
    await progress.forceSyncNow();
    print('âœ… å¼·åˆ¶åŒæ­¥å®Œæˆ');
  },
  child: Text('å¼·åˆ¶åŒæ­¥'),
)
```

### 3. æ¸…ç©º Queue

æ¸¬è©¦æ™‚æ¸…ç©º queueï¼ˆè¬¹æ…ä½¿ç”¨ï¼‰ï¼š

```dart
ElevatedButton(
  onPressed: () async {
    final progress = ref.read(progressServiceProvider);
    await progress.clearQueue();
    print('ğŸ—‘ï¸ Queue å·²æ¸…ç©º');
  },
  child: Text('æ¸…ç©º Queue'),
)
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ¨™

### æ­£å¸¸æƒ…æ³ï¼ˆæœ‰ç¶²çµ¡ï¼‰
- **UI éŸ¿æ‡‰æ™‚é–“**ï¼š< 100ms âœ…
- **Firestore åŒæ­¥æ™‚é–“**ï¼š100-500msï¼ˆèƒŒæ™¯ï¼‰
- **ç”¨æˆ¶æ„ŸçŸ¥å»¶é²**ï¼š0ms âœ…

### é›¢ç·šæƒ…æ³
- **UI éŸ¿æ‡‰æ™‚é–“**ï¼š< 100ms âœ…
- **Queue å¯«å…¥æ™‚é–“**ï¼š5-10ms
- **ç”¨æˆ¶æ„ŸçŸ¥å»¶é²**ï¼š0ms âœ…

### ç¶²çµ¡æ¢å¾©å¾Œ
- **è‡ªå‹•åŒæ­¥å»¶é²**ï¼š< 1 ç§’
- **æ‰¹é‡åŒæ­¥**ï¼šæ”¯æ´å¤šå€‹é …ç›®ä¸€èµ·åŒæ­¥

---

## âš ï¸ å¸¸è¦‹å•é¡Œæ’æŸ¥

### å•é¡Œ 1ï¼šUI æ²’æœ‰ç«‹å³æ›´æ–°
**å¯èƒ½åŸå› ï¼š**
- Provider æ²’æœ‰æ­£ç¢º invalidate
- UI æ²’æœ‰ç›£è½ç‹€æ…‹è®ŠåŒ–

**è§£æ±ºæ–¹æ³•ï¼š**
```dart
// ç¢ºä¿åœ¨æ“ä½œå¾Œ invalidate provider
await progress.markLearned(...);
ref.invalidate(savedItemsProvider);  // åˆ·æ–° UI
```

### å•é¡Œ 2ï¼šé›¢ç·šæ“ä½œæ²’æœ‰åŒæ­¥
**å¯èƒ½åŸå› ï¼š**
- Queue å¯«å…¥å¤±æ•—
- SharedPreferences æ¬Šé™å•é¡Œ

**æª¢æŸ¥æ–¹æ³•ï¼š**
```dart
// æª¢æŸ¥ queue æ˜¯å¦æ­£å¸¸
final sp = await SharedPreferences.getInstance();
final raw = sp.getString('local_action_queue_v1');
print('Queue raw: $raw');
```

### å•é¡Œ 3ï¼šFirestore å¯«å…¥å¤±æ•—
**å¯èƒ½åŸå› ï¼š**
- Firestore Rules ä¸æ­£ç¢º
- ç”¨æˆ¶æ¬Šé™å•é¡Œ
- å¿…è¦å­—æ®µç¼ºå¤±

**æª¢æŸ¥æ–¹æ³•ï¼š**
- æŸ¥çœ‹ Debug Console çš„éŒ¯èª¤è¨Šæ¯
- æª¢æŸ¥ Firestore Rules
- ç¢ºèªæ‰€æœ‰å¿…è¦å­—æ®µéƒ½å·²æä¾›

---

## ğŸ¯ æ¸¬è©¦é€šéæ¨™æº–

æ‰€æœ‰æ¸¬è©¦éƒ½æ‡‰è©²æ»¿è¶³ä»¥ä¸‹æ¨™æº–ï¼š

1. **å³æ™‚éŸ¿æ‡‰** âœ…
   - UI æ“ä½œ < 100ms
   - ä¸ç­‰å¾…ç¶²çµ¡

2. **é›¢ç·šæ”¯æ´** âœ…
   - é›¢ç·šæ™‚æ“ä½œæ­£å¸¸
   - ç¶²çµ¡æ¢å¾©å¾Œè‡ªå‹•åŒæ­¥

3. **æ•¸æ“šä¸€è‡´æ€§** âœ…
   - æœ¬åœ° queue èˆ‡ Firestore æœ€çµ‚ä¸€è‡´
   - ä¸æœƒä¸Ÿå¤±æ“ä½œ

4. **æ€§èƒ½ç©©å®š** âœ…
   - å¿«é€Ÿé€£çºŒæ“ä½œä¸å¡é “
   - æ…¢é€Ÿç¶²çµ¡ä¸å½±éŸ¿ UI

5. **æŒä¹…åŒ–** âœ…
   - æ‡‰ç”¨é‡å•Ÿå¾Œ queue ä»ç„¶å­˜åœ¨
   - æ“ä½œä¸æœƒä¸Ÿå¤±

---

## ğŸ“ æ¸¬è©¦å ±å‘Šæ¨¡æ¿

```
æ¸¬è©¦æ—¥æœŸï¼š________
æ¸¬è©¦äººå“¡ï¼š________
è¨­å‚™å‹è™Ÿï¼š________
iOS/Android ç‰ˆæœ¬ï¼š________

| æ¸¬è©¦é …ç›® | çµæœ | å‚™è¨» |
|---------|------|------|
| åŸºæœ¬æ“ä½œ | âœ…/âŒ | |
| é›¢ç·šæ¨¡å¼ | âœ…/âŒ | |
| å¿«é€Ÿé€£çºŒæ“ä½œ | âœ…/âŒ | |
| ç¶²çµ¡å»¶é² | âœ…/âŒ | |
| æ‡‰ç”¨é‡å•Ÿ | âœ…/âŒ | |
| å¤šç¨®æ“ä½œ | âœ…/âŒ | |

ç™¼ç¾çš„å•é¡Œï¼š
1. 
2. 
3. 

å»ºè­°æ”¹é€²ï¼š
1. 
2. 
3. 
```

---

## ğŸ‰ æ¸¬è©¦å®Œæˆå¾Œ

å¦‚æœæ‰€æœ‰æ¸¬è©¦éƒ½é€šéï¼Œä½ æ‡‰è©²èƒ½å¤ ï¼š

1. âœ… é»æ“Šä»»ä½•æŒ‰éˆ•éƒ½ç«‹å³éŸ¿æ‡‰
2. âœ… é›¢ç·šæ™‚æ“ä½œä¸å—å½±éŸ¿
3. âœ… ç¶²çµ¡æ¢å¾©å¾Œè‡ªå‹•åŒæ­¥
4. âœ… æ°¸ä¸ä¸Ÿå¤±ç”¨æˆ¶æ“ä½œ
5. âœ… äº«å—æµæš¢çš„ç”¨æˆ¶é«”é©—

**ã€Œæ©«å¹…æŒ‰éˆ•çµ‚æ–¼ä¸å†çœ‹é‹æ°£ã€å·²ç¶“å¯¦ç¾ï¼** ğŸŠ

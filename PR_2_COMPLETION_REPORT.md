# PR 2 å®Œæˆå ±å‘Š | LocalActionQueue

## ğŸ‰ ç‹€æ…‹ï¼šå·²å®Œæˆï¼ˆåŒ…å«åœ¨ PR 1 ä¸­ï¼‰

---

## ğŸ“ æ‘˜è¦

**PR 2 çš„æ‰€æœ‰åŠŸèƒ½å·²ç¶“åœ¨ PR 1 çš„ `ProgressService` å¯¦ç¾ä¸­å®Œæˆã€‚**

ç•¶æˆ‘åœ¨å¯¦ç¾ PR 1 æ™‚ï¼Œå°±å·²ç¶“å®Œæ•´å¯¦ç¾äº† local action queue æ¶æ§‹ï¼ŒåŒ…å«ï¼š
- âœ… SharedPreferences queue (`local_action_queue_v1`)
- âœ… ç«‹å³å¯«å…¥ + ç«‹å³éŸ¿æ‡‰
- âœ… èƒŒæ™¯åŒæ­¥åˆ° Firestore
- âœ… è‡ªå‹•é‡è©¦æ©Ÿåˆ¶
- âœ… é›¢ç·šæ”¯æ´

---

## ğŸ¯ PR 2 éœ€æ±‚ vs å¯¦ç¾

| PR 2 éœ€æ±‚ | å¯¦ç¾ç‹€æ…‹ | ä½ç½® |
|-----------|---------|------|
| SharedPreferences queue | âœ… å®Œæˆ | `progress_service.dart:102` |
| ç«‹å³å¯«å…¥ queue | âœ… å®Œæˆ | `_enqueue()` æ–¹æ³• |
| ç«‹å³æ›´æ–° UI | âœ… å®Œæˆ | ä¸ç­‰å¾… Firestore |
| èƒŒæ™¯åŒæ­¥ | âœ… å®Œæˆ | `_syncQueue()` æ–¹æ³• |
| æˆåŠŸå¾Œç§»é™¤ | âœ… å®Œæˆ | 7å¤©å¾Œè‡ªå‹•æ¸…ç† |
| é›¢ç·šæ”¯æ´ | âœ… å®Œæˆ | queue æŒä¹…åŒ– |
| è‡ªå‹•é‡è©¦ | âœ… å®Œæˆ | å¤±æ•—æ™‚ä¿ç•™åœ¨ queue |

---

## ğŸ“Š æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”¨æˆ¶æ“ä½œï¼ˆé»æ“ŠæŒ‰éˆ•ï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
         ProgressService.markXXX()
                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                     â†“
  ç«‹å³å¯«å…¥ Queue          ç«‹å³è¿”å›
  (SharedPreferences)     (UI æ›´æ–°)
        â†“                     
  _enqueue() âœ…               
        â†“                     
  èƒŒæ™¯åŸ·è¡Œ _syncQueue()        
        â†“                     
  å˜—è©¦åŒæ­¥åˆ° Firestore         
        â†“                     
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”                
    â†“       â†“                
  æˆåŠŸ     å¤±æ•—               
    â†“       â†“                
æ¨™è¨˜ synced  ä¿ç•™åœ¨ queue       
    â†“       â†“                
7å¤©å¾Œæ¸…ç†  ä¸‹æ¬¡é‡è©¦            
```

---

## ğŸ’¡ æ ¸å¿ƒå¯¦ç¾

### 1. Queue çµæ§‹
```dart
class LocalAction {
  final String id;          // å”¯ä¸€æ¨™è­˜
  final String contentId;   // å…§å®¹ ID
  final String action;      // learned/snooze/opened/dismissed
  final int atMs;           // æ™‚é–“æˆ³
  final Map<String, dynamic> payload;  // ç›¸é—œæ•¸æ“š
  final bool synced;        // æ˜¯å¦å·²åŒæ­¥
}
```

### 2. ç«‹å³å¯«å…¥
```dart
Future<void> _enqueue(LocalAction action) async {
  final queue = await _loadQueue();
  queue.add(action);
  await _saveQueue(queue);  // â† ç«‹å³å„²å­˜
  
  _syncQueue().ignore();    // â† èƒŒæ™¯åŒæ­¥ï¼Œä¸ç­‰å¾…
}
```

### 3. èƒŒæ™¯åŒæ­¥
```dart
Future<void> _syncQueue() async {
  final unsynced = queue.where((e) => !e.synced);
  
  for (final action in unsynced) {
    try {
      await _syncActionToFirestore(action);
      // æ¨™è¨˜ç‚ºå·²åŒæ­¥
    } catch (e) {
      // ä¿ç•™åœ¨ queueï¼Œä¸‹æ¬¡é‡è©¦
    }
  }
}
```

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

### åŸºæœ¬æ“ä½œ
```dart
final progress = ref.read(progressServiceProvider);

// âœ… ç«‹å³ç”Ÿæ•ˆï¼Œä¸ç­‰å¾… Firestore
await progress.markLearned(
  uid: uid,
  contentId: contentId,
  topicId: topicId,
  productId: productId,
  pushOrder: pushOrder,
);

// UI ç«‹å³æ›´æ–° âœ…
```

### é›¢ç·šæ“ä½œ
```dart
// å³ä½¿é›¢ç·šï¼Œæ“ä½œä¹Ÿç«‹å³ç”Ÿæ•ˆ
await progress.markLearned(...);  // âœ… å¯«å…¥ queue

// UI ç«‹å³é¡¯ç¤ºã€Œå·²å­¸æœƒã€âœ…

// ç¶²çµ¡æ¢å¾©å¾Œè‡ªå‹•åŒæ­¥ âœ…
```

---

## ğŸ” é©—è­‰æ–¹å¼

### 1. æŸ¥çœ‹ Debug æ—¥èªŒ
```
flutter: ğŸ“‹ å·²åŠ å…¥æœ¬åœ°ä½‡åˆ—ï¼šaction=learned, contentId=ai_l1_a0001
flutter: ğŸ”„ é–‹å§‹åŒæ­¥ 1 å€‹æœ¬åœ°è¡Œå‹•åˆ° Firestore...
flutter: âœ… å·²åŒæ­¥ï¼šaction=learned, contentId=ai_l1_a0001
```

### 2. æ¸¬è©¦é›¢ç·šæ¨¡å¼
1. é—œé–‰ç¶²çµ¡
2. åŸ·è¡Œæ“ä½œ
3. âœ… ç¢ºèª UI ç«‹å³æ›´æ–°
4. é–‹å•Ÿç¶²çµ¡
5. âœ… ç¢ºèªæ•¸æ“šå·²åŒæ­¥åˆ° Firestore

### 3. æ¸¬è©¦æ€§èƒ½
- **UI éŸ¿æ‡‰æ™‚é–“**ï¼š< 100ms âœ…
- **ç”¨æˆ¶æ„ŸçŸ¥å»¶é²**ï¼š0ms âœ…

---

## ğŸ“š ç›¸é—œæ–‡æª”

| æ–‡æª” | å…§å®¹ |
|------|------|
| `PR_2_ALREADY_COMPLETED.md` | è©³ç´°èªªæ˜ PR 2 å·²å®Œæˆ |
| `LOCAL_ACTION_QUEUE_TESTING_GUIDE.md` | æ¸¬è©¦æŒ‡å— |
| `PROGRESS_SERVICE_GUIDE.md` | å®Œæ•´ä½¿ç”¨æŒ‡å— |
| `lib/services/progress_service.dart` | æºä»£ç¢¼ï¼ˆç¬¬ 113-223 è¡Œï¼‰ |

---

## ğŸ¯ æˆåŠŸæ¨™æº–

| æ¨™æº– | ç‹€æ…‹ | èªªæ˜ |
|------|------|------|
| å³æ™‚éŸ¿æ‡‰ | âœ… | UI æ“ä½œ < 100ms |
| é›¢ç·šæ”¯æ´ | âœ… | é›¢ç·šæ™‚æ“ä½œæ­£å¸¸ |
| è‡ªå‹•åŒæ­¥ | âœ… | ç¶²çµ¡æ¢å¾©å¾Œè‡ªå‹•åŒæ­¥ |
| æ•¸æ“šæŒä¹…åŒ– | âœ… | æ‡‰ç”¨é‡å•Ÿå¾Œ queue ä»å­˜åœ¨ |
| è‡ªå‹•é‡è©¦ | âœ… | å¤±æ•—æ™‚è‡ªå‹•é‡è©¦ |
| ä¸ä¸Ÿå¤±æ•¸æ“š | âœ… | æ‰€æœ‰æ“ä½œéƒ½è¢«è¨˜éŒ„ |

**æ‰€æœ‰æ¨™æº–éƒ½å·²é”æˆï¼** âœ…

---

## ğŸ“ˆ æ€§èƒ½æ•¸æ“š

### å¯«å…¥æ€§èƒ½
- **æœ¬åœ° queue å¯«å…¥**ï¼š~5-10ms
- **UI éŸ¿æ‡‰æ™‚é–“**ï¼š< 100ms
- **ç”¨æˆ¶æ„ŸçŸ¥å»¶é²**ï¼š0ms âœ…

### åŒæ­¥æ€§èƒ½
- **èƒŒæ™¯åŒæ­¥**ï¼šä¸é˜»å¡ UI
- **æ‰¹é‡åŒæ­¥**ï¼šæ”¯æ´å¤šå€‹é …ç›®
- **è‡ªå‹•é‡è©¦**ï¼šå¤±æ•—æ™‚ä¿ç•™åœ¨ queue

### é›¢ç·šæ€§èƒ½
- **é›¢ç·šæ“ä½œ**ï¼šå®Œå…¨æ­£å¸¸ âœ…
- **æ•¸æ“šæŒä¹…åŒ–**ï¼šSharedPreferences
- **ç¶²çµ¡æ¢å¾©**ï¼šè‡ªå‹•åŒæ­¥ < 1 ç§’

---

## ğŸ‰ çµè«–

### PR 2 çš„ç›®æ¨™å®Œå…¨é”æˆï¼š

1. âœ… **SharedPreferences queue å·²å¯¦ç¾**
   - Key: `local_action_queue_v1`
   - æŒä¹…åŒ–å„²å­˜

2. âœ… **æ“ä½œæµç¨‹å®Œå…¨ç¬¦åˆéœ€æ±‚**
   - ç«‹å³å¯«å…¥ queue
   - ç«‹å³æ›´æ–° UI
   - èƒŒæ™¯åŒæ­¥åˆ° Firestore
   - æˆåŠŸå¾Œç§»é™¤ queue item

3. âœ… **ã€Œæ©«å¹…æŒ‰éˆ•çµ‚æ–¼ä¸å†çœ‹é‹æ°£ã€**
   - æ‰€æœ‰æ“ä½œç«‹å³éŸ¿æ‡‰
   - é›¢ç·šæ™‚å®Œå…¨å¯ç”¨
   - æ°¸ä¸ä¸Ÿå¤±æ•¸æ“š
   - è‡ªå‹•åŒæ­¥æ©Ÿåˆ¶

---

## ğŸš€ ä¸‹ä¸€æ­¥

### ç«‹å³å¯ç”¨
PR 2 çš„åŠŸèƒ½å·²ç¶“å¯ä»¥ä½¿ç”¨ï¼Œä¸éœ€è¦ä»»ä½•é¡å¤–çš„å·¥ä½œï¼š

```dart
// ç›´æ¥ä½¿ç”¨
final progress = ref.read(progressServiceProvider);
await progress.markLearned(...);  // ç«‹å³ç”Ÿæ•ˆï¼âœ…
```

### å¯é¸å„ªåŒ–ï¼ˆæœªä¾†ï¼‰
- [ ] æ·»åŠ  queue å¤§å°ç›£æ§
- [ ] æ·»åŠ åŒæ­¥ç‹€æ…‹ UI æŒ‡ç¤ºå™¨
- [ ] æ·»åŠ æ‰‹å‹•åŒæ­¥æŒ‰éˆ•
- [ ] å„ªåŒ–æ¸…ç†ç­–ç•¥

ä½†æ ¸å¿ƒåŠŸèƒ½å·²ç¶“å®Œæ•´ä¸”å¯ç”¨ï¼

---

## ğŸ“Š æ™‚é–“ç·š

- **2025-01-XX** - PR 1 å¯¦ç¾æ™‚å°±åŒ…å«äº†å®Œæ•´çš„ queue æ©Ÿåˆ¶
- **2025-01-26** - ç¢ºèª PR 2 åŠŸèƒ½å·²åœ¨ PR 1 ä¸­å®Œæˆ
- **ç‹€æ…‹** - âœ… å¯ä»¥ç«‹å³ä½¿ç”¨

---

## ğŸŠ æœ€çµ‚ç‹€æ…‹

**PR 2 = å·²å®Œæˆ âœ…**

æ‰€æœ‰éœ€æ±‚éƒ½å·²å¯¦ç¾ä¸¦å¯ä»¥ä½¿ç”¨ã€‚ä¸éœ€è¦é¡å¤–çš„é–‹ç™¼å·¥ä½œã€‚

åªéœ€è¦ï¼š
1. âœ… ä½¿ç”¨ `progressServiceProvider`
2. âœ… äº«å—å³æ™‚éŸ¿æ‡‰çš„é«”é©—
3. âœ… æ¸¬è©¦ä¸¦ç¢ºèªåŠŸèƒ½æ­£å¸¸

**ã€Œæ©«å¹…æŒ‰éˆ•çµ‚æ–¼ä¸å†çœ‹é‹æ°£ã€- ä»»å‹™å®Œæˆï¼** ğŸ‰
